<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Tessellation</title>
    <link rel="shortcut icon" type="image/png" href="https://stickyhand.github.io/imageedit_74_4611568328.ico">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            margin-top: 25px;
        }
        canvas {
            border: none;
            margin-top: 20px;
            background-color: transparent;
            position: absolute;
            top: 150px;
            left: 10px;
        }
        #canvas1{
            transform: scale(1, -1) rotate(270deg);
            position: absolute;
            top: 150px;
            left: 10px;
        }
    </style>
</head>
<body>
    <h1>Tessellation Tool</h1>
    <input type="file" id="upload" accept="image/*">
    <button id="saveButton" disabled>Save Tessellation</button>
    <canvas id="canvas"></canvas>
    <canvas id="canvas1"></canvas>

    <script>
        const uploadInput = document.getElementById('upload');
        const saveButton = document.getElementById('saveButton');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        const canvas1 = document.getElementById('canvas1');
        const ctx1 = canvas1.getContext('2d');

        uploadInput.addEventListener('change', handleImageUpload);
        saveButton.addEventListener('click', saveTessellation);

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const img = new Image();
            img.onload = () => {
                var scaleFactor = 500 / Math.max(img.width, img.height);
                var imgWidth = img.width * scaleFactor;
                var imgHeight = img.height * scaleFactor;

                // Set canvas size to match the image size
                canvas.width = canvas1.width = imgWidth/2;
                canvas.height = canvas1.height = imgHeight/2;

                // Step 1: Clip the canvas to a right triangle
                ctx.save(); // Save the current state of the canvas
                ctx.beginPath();
                ctx.moveTo(0, 0); // Top-left corner of the triangle
                ctx.lineTo(0, imgHeight / 2); // Left point of the triangle
                ctx.lineTo(imgWidth / 2, imgHeight / 2); // Right point of the triangle
                ctx.closePath();
                ctx.clip(); // Clip the canvas to the triangle

                // Step 2: Draw the image inside the clipped triangle
                ctx.drawImage(img, 0, 0, imgWidth, imgHeight);
                ctx.restore(); // Restore the canvas to its previous state (no clip)

                ctx1.save(); // Save the current state of the canvas
                ctx1.beginPath();
                ctx1.moveTo(0, 0); // Top-left corner of the triangle
                ctx1.lineTo(0, imgHeight / 2); // Left point of the triangle
                ctx1.lineTo(imgWidth / 2, imgHeight / 2); // Right point of the triangle
                ctx1.closePath();
                ctx1.clip(); // Clip the canvas to the triangle

                // Step 2: Draw the image inside the clipped triangle
                ctx1.drawImage(img, 0, 0, imgWidth, imgHeight);
                ctx1.restore(); // Restore the canvas to its previous state (no clip)


                // Enable the save button
                saveButton.disabled = false;
            };

            img.src = URL.createObjectURL(file);
        }

        async function saveTessellation() {
            if (!window.showSaveFilePicker) {
                alert("Your browser doesn't support the Save File Picker API.");
                return;
            }

            try {
                // Open the save file dialog
                const fileHandle = await showSaveFilePicker({
                    suggestedName: 'pattern.png',
                    types: [
                        {
                            description: 'PNG Image',
                            accept: { 'image/png': ['.png'] },
                        },
                        {
                            description: 'JPEG Image',
                            accept: { 'image/jpeg': ['.jpg', '.jpeg'] },
                        },
                        {
                            description: 'GIF Image',
                            accept: { 'image/gif': ['.gif'] },
                        },
                    ],
                });

                // Get a writable stream for the file
                const writableStream = await fileHandle.createWritable();

                // Convert canvas to blob and write it to the file
                const blob = await new Promise((resolve) =>
                    canvas.toBlob(
                        resolve,
                        fileHandle.name.endsWith('.png')
                            ? 'image/png'
                            : fileHandle.name.endsWith('.jpeg')
                            ? 'image/jpeg'
                            : fileHandle.name.endsWith('.jpg')
                            ? 'image/jpg'
                            : 'image/gif'
                    )
                );
                await writableStream.write(blob);
                await writableStream.close();

                alert('File saved successfully!');
            } catch (err) {
                console.error('Save cancelled or failed:', err);
            }
        }
    </script>
</body>
</html>
