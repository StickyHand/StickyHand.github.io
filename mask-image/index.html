<!DOCTYPE html>
<html>
<head>
  <title>Masked Text Tool with Font Check</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f0f0f0;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
      background: white;
    }
    #controls {
      margin-bottom: 20px;
    }
    label {
      margin-right: 10px;
    }
    #fontTest, #differentFontTest {
      position: absolute;
      left: -9999px;
      font-size: 40px;
      visibility: hidden;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<h1>Image-Masked Text</h1>

<div id="controls">
  <input onchange="render()" type="file" id="imageUpload" accept="image/*"><br>

  <input onchange="render()" type="text" id="imageURL" placeholder="Paste image URL">
  <button onclick="loadImageFromURL()">Load from URL</button><br>

  <textarea id="textInput" placeholder="Enter your text" oninput="render()"></textarea><br>

  <label>Font:</label>
  <select id="fontSelect" onchange="render()"></select>

  <input type="text" id="customFont" placeholder="Google Font name">
  <button id="load-font" onclick="loadCustomFont()">Load Font</button><br>

  <label>Font Size:</label>
  <input onchange="render()" type="range" id="fontSize" min="40" max="400" value="160">

  <label>Bold Thickness:</label>
  <input onchange="render()" type="range" id="boldness" min="1" max="30" value="0">

  <label>Underline Height:</label>
  <input onchange="render()" type="range" id="underlineHeight" min="0" max="50" value="0">

  <label><input onchange="render()" type="checkbox" id="italicToggle"> Italic</label><br>
  
  <label>Shift Text:</label>
  <input onchange="render()" type="range" id="shift-text" min="-100" max="100" value="0" step="3"><br>

  <button onclick="render()">Mask Text</button>
  <button onclick="download()">Download PNG</button>
</div>

<canvas id="canvas" width="800" height="400"></canvas>

<span id="fontTest">abcdefghijklmnopqrstuvwxyz0123456789`~!@#$%^&*()-=_+{}[]|\:";'?,./</span>
<span id="differentFontTest" style="font-family: monospace;">abcdefghijklmnopqrstuvwxyz0123456789`~!@#$%^&*()-=_+{}[]|\:";'?,./</span>

<script>
  if(localStorage.getItem("allGoogleFonts")) {
    var fontStorage = JSON.parse(localStorage.getItem("allGoogleFonts"));
    for(var i = 0; i < fontStorage.length; i++) {
      var name = fontStorage[i];
      var familyParam = name.replace(/ /g, '+');
      var fontURL = 'https://fonts.googleapis.com/css2?family=' + familyParam + '&display=swap';
      var option = new Option(name, name);
      var link = document.createElement('link');
      link.href = fontURL;
      link.rel = 'stylesheet';
      document.head.appendChild(link);
      document.getElementById('fontSelect').appendChild(option);
      document.getElementById('fontSelect').value = name;
    }
  }

  var canvas = document.getElementById('canvas');
  var ctx = canvas.getContext('2d');
  var image = new Image();
  var imageLoaded = false;

  canvas.addEventListener('dragover', e => e.preventDefault());
  canvas.addEventListener('drop', function(e) {
    e.preventDefault();
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      var reader = new FileReader();
      reader.onload = evt => image.src = evt.target.result;
      reader.readAsDataURL(e.dataTransfer.files[0]);
    }
  });

  document.getElementById('imageUpload').addEventListener('change', function(e) {
    var reader = new FileReader();
    reader.onload = event => image.src = event.target.result;
    reader.readAsDataURL(e.target.files[0]);
  });

  function loadImageFromURL() {
    var url = document.getElementById('imageURL').value.trim();
    if (url) {
      image.crossOrigin = "anonymous";
      image.src = url;
    }
  }

  image.onload = () => imageLoaded = true;

  function capitalize(str) {
    return str.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
  }

  function loadCustomFont() {
    var name = capitalize(document.getElementById('customFont').value.trim().toLowerCase());
    if (!name) return;

    var familyParam = name.replace(/ /g, '+');
    var fontURL = 'https://fonts.googleapis.com/css2?family=' + familyParam + '&display=swap';
    var link = document.createElement('link');
    link.href = fontURL;
    link.rel = 'stylesheet';
    document.head.appendChild(link);

    var test = document.getElementById('fontTest');
    var differentFontTest = document.getElementById('differentFontTest');
    var fontTest = name.includes("mono") ? "serif" : "monospace";
    test.style.fontFamily = `'${name}', ${fontTest}`;

    document.getElementById("load-font").innerHTML = "Loading...";    
    document.getElementById("load-font").disabled = true;

    setTimeout(() => {
      var alreadyIncluded = false;
      var fontStorage = JSON.parse(localStorage.getItem("allGoogleFonts") || "[]");
      if(fontStorage.includes(name)) alreadyIncluded = true;

      document.getElementById("load-font").innerHTML = "Load Font";  
      document.getElementById("load-font").disabled = false;

      if (test.offsetWidth === differentFontTest.offsetWidth) {
        alert(name + " is a non-existing font!");
      } else if (alreadyIncluded) {
        alert(name + " is an already existing font!");
      } else {
        var option = new Option(name, name);
        document.getElementById('fontSelect').appendChild(option);
        document.getElementById('fontSelect').value = name;
        fontStorage.push(name);
        fontStorage.sort();
        localStorage.setItem("allGoogleFonts", JSON.stringify(fontStorage));
        render();
      }
    }, 1000);
  }

  function render() {
    if (!imageLoaded || !image.src) return console.log("need an image");

    var rawText = document.getElementById('textInput').value;
    if (!rawText) return console.log("need some text");
    var lines = rawText.split('\n');

    var font = document.getElementById('fontSelect').value;
    var size = +document.getElementById('fontSize').value;
    var stroke = +document.getElementById('boldness').value;
    var underline = +document.getElementById('underlineHeight').value;
    var italic = document.getElementById('italicToggle').checked;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.globalCompositeOperation = "source-over";
    ctx.font = (italic ? "italic " : "") + size + "px '" + font + "'";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    var x = canvas.width / 2;
    var y = canvas.height / 2 + parseInt(document.getElementById("shift-text").value);
    var lineHeight = size * 1.2;
    y -= (lines.length - 1) * lineHeight / 2;

    ctx.lineWidth = stroke;
    ctx.fillStyle = "#000";
    ctx.strokeStyle = "#000";

    for (var i = 0; i < lines.length; i++) {
      var line = lines[i];
      var lineY = y + i * lineHeight;
      var lineW = ctx.measureText(line).width;

      ctx.strokeText(line, x, lineY);
      ctx.fillText(line, x, lineY);

      if (underline > 0) {
        var underlineY = lineY + size / 3;
        ctx.fillRect(x - lineW / 2, underlineY, lineW, underline);
      }
    }

    ctx.globalCompositeOperation = "source-in";
    drawImageCover(ctx, image, canvas.width, canvas.height);
    ctx.globalCompositeOperation = "source-over";
  }

  function download() {
    var link = document.createElement('a');
    link.download = 'masked-text.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  }

  function drawImageCover(ctx, img, canvasW, canvasH) {
    var iw = img.width, ih = img.height;
    var scale = Math.max(canvasW / iw, canvasH / ih);
    var sw = canvasW / scale, sh = canvasH / scale;
    var sx = (iw - sw) / 2, sy = (ih - sh) / 2;
    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, canvasW, canvasH);
  }
</script>

</body>
</html>
